# Query: Q6 find_report_statistics
# Purpose: Management dashboard - report processing metrics
# Parameters: ?from (dateTime), ?to (dateTime), ?limit (integer), ?organizationURI (optional)
# Security: TLP-RED content excluded by default

PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX cacontology-hotlines: <https://cacontology.projectvic.org/hotlines/2025/core#>
PREFIX cacontology: <https://cacontology.projectvic.org/0.3#>
PREFIX uco-core: <https://ontology.unifiedcyberontology.org/uco/core/>
PREFIX uco-observable: <https://ontology.unifiedcyberontology.org/uco/observable/>
PREFIX uco-confidentiality: <https://ontology.unifiedcyberontology.org/uco/confidentiality/>

SELECT ?organization ?yearMonth
       (COUNT(DISTINCT ?report) AS ?totalReports)
       (COUNT(DISTINCT ?evidence) AS ?totalEvidence)
       (AVG(?processingTime) AS ?avgProcessingTimeDays)
       (COUNT(DISTINCT ?crossBorderAction) AS ?crossBorderForwardCount)
       (COUNT(DISTINCT ?rescueAction) AS ?rescueActionCount)
WHERE {
    # Parameter defaults
    VALUES (?from ?to ?limit ?organizationURI) {
        ("2025-01-01T00:00:00Z"^^xsd:dateTime "2025-12-31T23:59:59Z"^^xsd:dateTime 100 UNDEF) # UNDEF for optional org
    }
    
    ?report a ?reportType ;
            cacontology-hotlines:receivedBy ?organization ;
            cacontology-hotlines:createdTime ?createdTime ;
            cacontology-hotlines:hasEvidence ?evidence .
    
    # Filter by specific organization if URI is provided
    FILTER(!BOUND(?organizationURI) || (?organization = ?organizationURI))

    BIND(STRDT(CONCAT(STR(YEAR(?createdTime)), "-", STR(MONTH(?createdTime))), xsd:gYearMonth) AS ?yearMonth)
    
    OPTIONAL {
        ?report cacontology-hotlines:status cacontology-hotlines:status-closed ;
                cacontology-hotlines:closedAt ?closedTime .
        BIND(DAYS(?closedTime - ?createdTime) AS ?processingTime) # Simpler duration for days
    }
    
    OPTIONAL {
        ?report cacontology-hotlines:triggersAction ?crossBorderAction .
        ?crossBorderAction a cacontology-hotlines:ForwardToLEAction .
        ?organization cacontology-hotlines:countryCode ?sourceCountry .
        ?crossBorderAction cacontology-hotlines:forwardsTo ?targetOrg .
        ?targetOrg cacontology-hotlines:countryCode ?targetCountry .
        FILTER(?sourceCountry != ?targetCountry)
    }
    
    OPTIONAL {
        ?report cacontology-hotlines:triggersAction ?rescueAction .
        ?rescueAction a cacontology:VictimRescueAction ; # Assuming VictimRescueAction is in icac namespace
                     cacontology-hotlines:outcome cacontology-hotlines:outcome-success .
    }
    
    FILTER(?createdTime >= ?from && ?createdTime <= ?to)

    # Security filter
    FILTER NOT EXISTS {
        ?report uco-confidentiality:TLP-RED ?whatever .
    }
}
GROUP BY ?organization ?yearMonth
ORDER BY ?organization DESC(?yearMonth)
LIMIT ?limit 