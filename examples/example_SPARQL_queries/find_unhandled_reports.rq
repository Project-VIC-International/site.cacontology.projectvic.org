# Query: Q9 find_unhandled_reports
# Purpose: Operations dashboard - reports not yet forwarded to LE
# Parameters: ?from (dateTime), ?to (dateTime), ?limit (integer)
# Security: TLP-RED content excluded by default

PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX cacontology-hotlines: <https://cacontology.projectvic.org/hotlines/2025/core#>
PREFIX cacontology: <https://cacontology.projectvic.org/0.3#>
PREFIX uco-core: <https://ontology.unifiedcyberontology.org/uco/core/>
PREFIX uco-observable: <https://ontology.unifiedcyberontology.org/uco/observable/>
PREFIX uco-confidentiality: <https://ontology.unifiedcyberontology.org/uco/confidentiality/>

SELECT DISTINCT ?report ?reportType ?status ?createdTime ?evidenceCount ?daysSinceCreation
WHERE {
    # Parameter defaults
    VALUES (?from ?to ?limit) {
        ("2025-01-01T00:00:00Z"^^xsd:dateTime "2025-12-31T23:59:59Z"^^xsd:dateTime 100)
    }
    
    ?report a ?reportType ;
            cacontology-hotlines:status ?status ;
            cacontology-hotlines:createdTime ?createdTime ;
            cacontology-hotlines:hasEvidence ?evidence .
    
    {
        SELECT ?report (COUNT(?evidence) as ?evidenceCount)
        WHERE {
            ?report cacontology-hotlines:hasEvidence ?evidence .
        }
        GROUP BY ?report
    }
    
    BIND(DAYS(NOW() - ?createdTime) AS ?daysSinceCreation) # Use DAYS for simpler age
    
    FILTER NOT EXISTS {
        ?report cacontology-hotlines:triggersAction ?action .
        ?action a cacontology-hotlines:ForwardToLEAction ;
                cacontology-hotlines:outcome cacontology-hotlines:outcome-success . # Only exclude successful forwards
    }
    
    VALUES ?status { # Reports that are still considered open for this purpose
        cacontology-hotlines:status-new
        cacontology-hotlines:status-in-progress
        cacontology-hotlines:status-in-review
        # Exclude cacontology-hotlines:status-forwarded as we are looking for un-forwarded, 
        # or forwards that didn't succeed if that's modeled.
    }

    FILTER(?createdTime >= ?from && ?createdTime <= ?to)

    # Security filter
    FILTER NOT EXISTS {
        ?report uco-confidentiality:TLP-RED ?whatever .
    }
}
ORDER BY ?daysSinceCreation DESC # Sort by oldest first
LIMIT ?limit 