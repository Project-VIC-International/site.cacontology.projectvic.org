# =============================================================================
# gUFO-Enhanced Analytics Queries
# =============================================================================
# Advanced SPARQL queries leveraging gUFO foundational ontology concepts
# for enhanced investigation analytics and pattern recognition

PREFIX cacontology-gufo: <https://cacontology.projectvic.org/gufo#>
PREFIX cacontology-temporal: <https://cacontology.projectvic.org/temporal#>
PREFIX gufo: <http://purl.org/nemo/gufo#>
PREFIX uco-core: <https://ontology.unifiedcyberontology.org/uco/core/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# =============================================================================
# QUERY 1: Investigation Phase Performance Analytics
# =============================================================================

SELECT ?phase_type ?avg_duration ?efficiency_score ?case_count WHERE {
  {
    SELECT ?phase_type 
           (AVG(?duration_hours) as ?avg_duration)
           (AVG(?efficiency) as ?efficiency_score)
           (COUNT(?phase) as ?case_count) WHERE {
      ?phase rdf:type ?phase_type ;
             cacontology-gufo:phaseDuration ?duration ;
             cacontology-temporal:phaseEfficiency ?efficiency .
      
      # Convert duration to hours for analysis
      BIND(
        IF(CONTAINS(STR(?duration), "PT"), 
           xsd:decimal(REPLACE(REPLACE(STR(?duration), "PT", ""), "H.*", "")),
           xsd:decimal(REPLACE(REPLACE(STR(?duration), "P", ""), "D.*", "")) * 24
        ) as ?duration_hours
      )
      
      FILTER(?phase_type IN (
        cacontology-gufo:InitialPhase, cacontology-gufo:AnalysisPhase, 
        cacontology-gufo:LegalProcessPhase, cacontology-gufo:EvidencePhase,
        cacontology-gufo:ResolutionPhase
      ))
    }
    GROUP BY ?phase_type
  }
}
ORDER BY ?avg_duration

# =============================================================================
# QUERY 2: Role Conflict Detection and Prevention
# =============================================================================

SELECT ?person ?conflicting_roles ?investigation ?conflict_severity WHERE {
  ?person cacontology-gufo:playsRole ?role1 ;
          cacontology-gufo:playsRole ?role2 .
  
  ?role1 cacontology-gufo:participatesInInvestigation ?investigation .
  ?role2 cacontology-gufo:participatesInInvestigation ?investigation .
  
  # Detect conflicting role combinations
  FILTER(
    (?role1 = cacontology-gufo:VictimRole && ?role2 = cacontology-gufo:OffenderRole) ||
    (?role1 = cacontology-gufo:OffenderRole && ?role2 = cacontology-gufo:VictimRole) ||
    (?role1 = cacontology-gufo:InvestigatorRole && ?role2 = cacontology-gufo:OffenderRole) ||
    (?role1 = cacontology-gufo:OffenderRole && ?role2 = cacontology-gufo:InvestigatorRole)
  )
  
  BIND(CONCAT(STR(?role1), " + ", STR(?role2)) as ?conflicting_roles)
  BIND(
    IF(?role1 = cacontology-gufo:VictimRole && ?role2 = cacontology-gufo:OffenderRole, "CRITICAL",
    IF(?role1 = cacontology-gufo:InvestigatorRole && ?role2 = cacontology-gufo:OffenderRole, "CRITICAL",
    "HIGH")) as ?conflict_severity
  )
}

# =============================================================================
# QUERY 3: Temporal Investigation Pattern Analysis
# =============================================================================

SELECT ?pattern_type ?frequency ?avg_success_rate ?avg_total_duration WHERE {
  {
    SELECT ?pattern_type 
           (COUNT(?inv) as ?frequency)
           (AVG(?completion_rate) as ?avg_success_rate)
           (AVG(?total_duration) as ?avg_total_duration) WHERE {
      
      ?inv rdf:type cacontology-gufo:Investigation ;
           cacontology-temporal:hasTimeToResolution ?resolution_time ;
           cacontology-temporal:hasActiveDuration ?active_time ;
           cacontology-gufo:hasPhase ?phase .
      
      ?phase cacontology-temporal:phaseCompletionRate ?completion_rate .
      
      # Convert duration to days
      BIND(xsd:decimal(REPLACE(REPLACE(STR(?resolution_time), "P", ""), "D.*", "")) as ?total_duration)
      
      # Classify investigation patterns
      BIND(
        IF(?total_duration <= 30, "Fast Track (â‰¤30 days)",
        IF(?total_duration <= 90, "Standard (31-90 days)",
        IF(?total_duration <= 180, "Extended (91-180 days)",
        "Complex (>180 days)"))) as ?pattern_type
      )
    }
    GROUP BY ?pattern_type
  }
}
ORDER BY ?avg_total_duration

# =============================================================================
# QUERY 4: Suspension/Resumption Impact Analysis
# =============================================================================

SELECT ?investigation ?suspension_count ?total_suspended_days ?impact_score WHERE {
  ?investigation rdf:type cacontology-gufo:Investigation ;
                 cacontology-temporal:hasSuspendedDuration ?suspended_duration ;
                 cacontology-temporal:hasActiveDuration ?active_duration ;
                 cacontology-temporal:hasTimeToResolution ?total_duration .
  
  # Count suspension events
  {
    SELECT ?investigation (COUNT(?suspension) as ?suspension_count) WHERE {
      ?suspension rdf:type cacontology-temporal:SuspensionEvent ;
                  cacontology-temporal:suspends ?investigation .
    }
    GROUP BY ?investigation
  }
  
  # Convert suspended duration to days
  BIND(xsd:decimal(REPLACE(REPLACE(STR(?suspended_duration), "P", ""), "D.*", "")) as ?total_suspended_days)
  
  # Calculate impact score (suspended time / total time)
  BIND(
    xsd:decimal(REPLACE(REPLACE(STR(?suspended_duration), "P", ""), "D.*", "")) /
    xsd:decimal(REPLACE(REPLACE(STR(?total_duration), "P", ""), "D.*", ""))
    as ?impact_score
  )
  
  FILTER(?suspension_count > 0)
}
ORDER BY DESC(?impact_score)

# =============================================================================
# QUERY 5: Multi-Jurisdiction Coordination Effectiveness
# =============================================================================

SELECT ?coordination_type ?jurisdiction_count ?avg_coordination_duration ?success_rate WHERE {
  {
    SELECT ?coordination_type 
           (AVG(?jurisdiction_count) as ?jurisdiction_count)
           (AVG(?duration_days) as ?avg_coordination_duration)
           (AVG(?completion_rate) as ?success_rate) WHERE {
      
      ?situation rdf:type cacontology-temporal:MultiJurisdictionCoordinationSituation ;
                 gufo:hasBeginPointInXSDDateTimeStamp ?begin ;
                 gufo:hasEndPointInXSDDateTimeStamp ?end .
      
      ?investigation cacontology-temporal:hasTimeToResolution ?total_time ;
                     cacontology-gufo:hasPhase ?phase .
      
      ?phase cacontology-temporal:phaseCompletionRate ?completion_rate .
      
      # Calculate coordination duration
      BIND((xsd:dateTime(?end) - xsd:dateTime(?begin)) / xsd:dayTimeDuration("P1D") as ?duration_days)
      
      # Estimate jurisdiction count (simplified - would need additional data)
      BIND(
        IF(?duration_days <= 7, 2,
        IF(?duration_days <= 21, 3,
        IF(?duration_days <= 45, 4, 5))) as ?jurisdiction_count
      )
      
      # Classify coordination type
      BIND(
        IF(?jurisdiction_count = 2, "Bi-Jurisdictional",
        IF(?jurisdiction_count = 3, "Multi-State",
        IF(?jurisdiction_count = 4, "Regional",
        "National/International"))) as ?coordination_type
      )
    }
    GROUP BY ?coordination_type
  }
}
ORDER BY ?jurisdiction_count

# =============================================================================
# QUERY 6: Role Temporal Dynamics Analysis
# =============================================================================

SELECT ?role_type ?avg_role_duration ?escalation_frequency ?overlap_patterns WHERE {
  {
    SELECT ?role_type 
           (AVG(?role_duration_days) as ?avg_role_duration)
           (COUNT(?escalation) as ?escalation_frequency)
           (COUNT(?overlap) as ?overlap_patterns) WHERE {
      
      ?role rdf:type ?role_type ;
            cacontology-gufo:hasRoleBeginPoint ?begin ;
            cacontology-gufo:hasRoleEndPoint ?end .
      
      # Calculate role duration
      BIND((xsd:dateTime(?end) - xsd:dateTime(?begin)) / xsd:dayTimeDuration("P1D") as ?role_duration_days)
      
      # Check for role escalations
      OPTIONAL {
        ?escalation rdf:type cacontology-temporal:RoleEscalation ;
                    cacontology-temporal:involvesRole ?role .
      }
      
      # Check for role overlaps
      OPTIONAL {
        ?overlap rdf:type cacontology-temporal:SimultaneousRoleSituation ;
                 cacontology-temporal:involvesRole ?role .
      }
      
      FILTER(?role_type IN (
        cacontology-gufo:InvestigatorRole, cacontology-gufo:VictimRole, 
        cacontology-gufo:OffenderRole, cacontology-gufo:WitnessRole,
        cacontology-gufo:InformantRole, cacontology-gufo:RescuerRole
      ))
    }
    GROUP BY ?role_type
  }
}
ORDER BY DESC(?avg_role_duration)

# =============================================================================
# QUERY 7: Investigation Outcome Prediction Features
# =============================================================================

SELECT ?investigation ?feature_vector ?predicted_risk_level WHERE {
  ?investigation rdf:type cacontology-gufo:Investigation ;
                 cacontology-temporal:hasTimeToResolution ?total_duration ;
                 cacontology-temporal:urgencyLevel ?urgency .
  
  # Count phases
  {
    SELECT ?investigation (COUNT(?phase) as ?phase_count) WHERE {
      ?investigation cacontology-gufo:hasPhase ?phase .
    }
    GROUP BY ?investigation
  }
  
  # Count roles
  {
    SELECT ?investigation (COUNT(?role) as ?role_count) WHERE {
      ?investigation cacontology-gufo:hasRole ?role .
    }
    GROUP BY ?investigation
  }
  
  # Count events
  {
    SELECT ?investigation (COUNT(?event) as ?event_count) WHERE {
      ?event cacontology-gufo:participatesInInvestigation ?investigation .
    }
    GROUP BY ?investigation
  }
  
  # Count suspensions
  {
    SELECT ?investigation (COUNT(?suspension) as ?suspension_count) WHERE {
      ?suspension rdf:type cacontology-temporal:SuspensionEvent ;
                  cacontology-temporal:suspends ?investigation .
    }
    GROUP BY ?investigation
  }
  
  # Build feature vector for ML
  BIND(CONCAT(
    "phases:", STR(?phase_count), 
    "|roles:", STR(?role_count),
    "|events:", STR(?event_count),
    "|urgency:", STR(?urgency),
    "|suspensions:", STR(?suspension_count)
  ) as ?feature_vector)
  
  # Predict risk level (simplified rule-based)
  BIND(
    IF(?urgency >= 4 && ?suspension_count > 0, "HIGH",
    IF(?urgency >= 3 && ?phase_count > 4, "MEDIUM",
    "LOW")) as ?predicted_risk_level
  )
}

# =============================================================================
# QUERY 8: Advanced Event Dependency Analysis
# =============================================================================

SELECT ?investigation ?event_chain_length ?parallel_events ?critical_path WHERE {
  ?investigation rdf:type cacontology-gufo:Investigation .
  
  # Count event dependencies
  {
    SELECT ?investigation (COUNT(?dependency) as ?event_chain_length) WHERE {
      ?event cacontology-gufo:participatesInInvestigation ?investigation ;
             cacontology-temporal:hasPrerequisiteEvent ?dependency .
    }
    GROUP BY ?investigation
  }
  
  # Count parallel events
  {
    SELECT ?investigation (COUNT(?parallel) as ?parallel_events) WHERE {
      ?event cacontology-gufo:participatesInInvestigation ?investigation ;
             cacontology-temporal:hasParallelEvent ?parallel .
    }
    GROUP BY ?investigation
  }
  
  # Identify critical path (longest dependency chain)
  BIND(
    IF(?event_chain_length > ?parallel_events, "Sequential Critical Path",
    IF(?parallel_events > ?event_chain_length, "Parallel Optimized",
    "Balanced Workflow")) as ?critical_path
  )
  
  FILTER(?event_chain_length > 0 || ?parallel_events > 0)
}
ORDER BY DESC(?event_chain_length)

# =============================================================================
# QUERY 9: gUFO Validation and Consistency Check
# =============================================================================

SELECT ?validation_type ?entity_count ?compliance_rate WHERE {
  {
    SELECT "Phase Modeling" as ?validation_type (COUNT(?phase) as ?entity_count) (1.0 as ?compliance_rate) WHERE {
      ?phase rdf:type gufo:Phase ;
             rdfs:subClassOf cacontology-gufo:Investigation .
    }
  } UNION {
    SELECT "Role Modeling" as ?validation_type (COUNT(?role) as ?entity_count) (1.0 as ?compliance_rate) WHERE {
      ?role rdf:type gufo:Role ;
            rdfs:subClassOf cacontology-gufo:Person .
    }
  } UNION {
    SELECT "Event Modeling" as ?validation_type (COUNT(?event) as ?entity_count) (1.0 as ?compliance_rate) WHERE {
      ?event rdf:type gufo:Event ;
             rdfs:subClassOf uco-action:Action .
    }
  } UNION {
    SELECT "Situation Modeling" as ?validation_type (COUNT(?situation) as ?entity_count) (1.0 as ?compliance_rate) WHERE {
      ?situation rdf:type gufo:Situation .
    }
  }
}

# =============================================================================
# QUERY 10: Investigation Success Pattern Recognition
# =============================================================================

SELECT ?success_pattern ?pattern_frequency ?avg_completion_rate ?key_factors WHERE {
  {
    SELECT ?success_pattern 
           (COUNT(?inv) as ?pattern_frequency)
           (AVG(?completion_rate) as ?avg_completion_rate)
           (GROUP_CONCAT(DISTINCT ?factor; separator=", ") as ?key_factors) WHERE {
      
      ?inv rdf:type cacontology-gufo:Investigation ;
           cacontology-gufo:hasPhase ?phase .
      
      ?phase cacontology-temporal:phaseCompletionRate ?completion_rate .
      
      # Identify success factors
      OPTIONAL {
        ?inv cacontology-temporal:urgencyLevel ?urgency .
        FILTER(?urgency >= 4)
        BIND("High Urgency" as ?factor)
      }
      
      OPTIONAL {
        ?inv cacontology-temporal:hasActiveDuration ?active_duration .
        BIND(xsd:decimal(REPLACE(REPLACE(STR(?active_duration), "P", ""), "D.*", "")) as ?active_days)
        FILTER(?active_days <= 30)
        BIND("Fast Resolution" as ?factor)
      }
      
      OPTIONAL {
        ?role cacontology-gufo:participatesInInvestigation ?inv .
        ?role rdf:type cacontology-gufo:InformantRole .
        BIND("Informant Support" as ?factor)
      }
      
      # Classify success patterns
      BIND(
        IF(?completion_rate >= 0.9, "High Success (90%+)",
        IF(?completion_rate >= 0.75, "Good Success (75-89%)",
        IF(?completion_rate >= 0.5, "Moderate Success (50-74%)",
        "Low Success (<50%)"))) as ?success_pattern
      )
    }
    GROUP BY ?success_pattern
  }
}
ORDER BY DESC(?avg_completion_rate) 